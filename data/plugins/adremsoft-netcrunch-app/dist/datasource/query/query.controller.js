'use strict';System.register(['../css/query.editor.css!','../directives/ncSpinner.directive','../directives/ncFocus.directive','app/plugins/sdk','../common'],function(_export){'use strict';var QueryCtrl,datasourceURL,_createClass,PRIVATE_PROPERTIES,NET_CRUNCH_QUERY_CONTROLLER_DI,DEFAULT_NODE_NAME,DEFAULT_COUNTER_DISPLAY_NAME,COUNTERS_SUBMENU_LENGTH,NetCrunchQueryController;function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError('Cannot call a class as a function')}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called');return call&&('object'==typeof call||'function'==typeof call)?call:self}function _inherits(subClass,superClass){if('function'!=typeof superClass&&null!==superClass)throw new TypeError('Super expression must either be null or a function, not '+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}return{setters:[function(){},function(){},function(){},function(_appPluginsSdk){QueryCtrl=_appPluginsSdk.QueryCtrl},function(_common){datasourceURL=_common.datasourceURL}],execute:function(){_createClass=function(){function defineProperties(target,props){for(var descriptor,i=0;i<props.length;i++)descriptor=props[i],descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,'value'in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();PRIVATE_PROPERTIES={uiSegmentSrv:Symbol('uiSegmentSrv'),scope:Symbol('scope'),nodeMap:Symbol('nodeMap'),nodeSegment:Symbol('nodeSegment'),nodeSpinner:Symbol('nodeSpinner'),nodeFocus:Symbol('nodeFocus'),counterName:Symbol('counterName'),counterSpinner:Symbol('counterSpinner'),counterFocus:Symbol('counterFocus'),counters:Symbol('counters')};NET_CRUNCH_QUERY_CONTROLLER_DI=['uiSegmentSrv','$scope','$rootScope','$timeout'];DEFAULT_NODE_NAME='Select node';DEFAULT_COUNTER_DISPLAY_NAME='Select counter';COUNTERS_SUBMENU_LENGTH=25;_export('NetCrunchQueryController',NetCrunchQueryController=function(_QueryCtrl){function NetCrunchQueryController(a,b,c,d){_classCallCheck(this,NetCrunchQueryController);var _this=_possibleConstructorReturn(this,(NetCrunchQueryController.__proto__||Object.getPrototypeOf(NetCrunchQueryController)).call(this));return c.$on('template-variable-value-updated',function(){return d(function(){return _this.variableChanged()},0)}),_this[PRIVATE_PROPERTIES.uiSegmentSrv]=a,_this[PRIVATE_PROPERTIES.scope]=b,_this[PRIVATE_PROPERTIES.nodeMap]=new Map,_this[PRIVATE_PROPERTIES.nodeSegment]=_this.createDefaultNodeSegment(DEFAULT_NODE_NAME),_this[PRIVATE_PROPERTIES.nodeSpinner]=!1,_this[PRIVATE_PROPERTIES.nodeFocus]=!1,_this[PRIVATE_PROPERTIES.counterName]=null,_this[PRIVATE_PROPERTIES.counterSpinner]=!1,_this[PRIVATE_PROPERTIES.counterFocus]=!1,_this[PRIVATE_PROPERTIES.counters]=[],_this.localVars=Object.create(null),_this.processingNode=!0,_this.nodeReady=!1,_this.datasource.nodes().then(function(){_this.processingNode=!1,_this.updateView(),null==_this.target.nodeID?_this.nodeFocus=!0:_this.nodeChanged(_this.target.nodeID)}),_this.processingCounter=!0,_this.counterReady=!1,_this.showOptions=null!=_this.showOptions&&_this.showOptions,_this.target.alias=_this.target.alias||'',_this.target.series=_this.target.series||{min:!1,avg:!0,max:!1},c.$on('template-variable-value-updated',function(){return d(function(){return _this.variableChanged()},0)}),_this}return _inherits(NetCrunchQueryController,_QueryCtrl),_createClass(NetCrunchQueryController,[{key:'createDefaultNodeSegment',value:function(a){return this[PRIVATE_PROPERTIES.uiSegmentSrv].newSegment({cssClass:'nc-reset-segment',fake:!0,type:'value',html:'<div class="nc-default-tile">'+a+'</div>',value:a})}},{key:'createNodeSegment',value:function(a){var b='\n      <div class="nc-node-tile">\n        <img class="nc-node-icon" src='+a.iconUrl+'>\n        <div class="nc-node-description">\n          <span class="nc-node-name">'+a.name+'</span>\n          <span class="nc-node-address">'+a.address+'</span>\n        </div>\n      </div>\n    ';return this[PRIVATE_PROPERTIES.uiSegmentSrv].newSegment({cssClass:'nc-reset-segment',fake:!0,type:'value',html:b,value:NetCrunchQueryController.nodeDisplayValue(a)})}},{key:'createVariableSegment',value:function(a){return this[PRIVATE_PROPERTIES.uiSegmentSrv].newSegment({cssClass:'nc-reset-segment',expandable:!0,fake:!0,type:'template',html:'<div class="nc-default-tile">$'+a+'</div>',value:'$'+a})}},{key:'targetChanged',value:function(){this.refresh()}},{key:'nodeSpinnerChanged',value:function(a){this[PRIVATE_PROPERTIES.nodeSpinner]=a}},{key:'counterSpinnerChanged',value:function(a){this[PRIVATE_PROPERTIES.counterSpinner]=a}},{key:'updateView',value:function(){this[PRIVATE_PROPERTIES.scope].$apply()}},{key:'getNodes',value:function(){function a(){return c.datasource.getNodeVariables().sort(function(d,e){return d.name.toLocaleString(e.name)}).map(function(d){return c.createVariableSegment(d.name)})}function b(d){return c[PRIVATE_PROPERTIES.nodeMap].clear(),d.map(function(e){var f=c.createNodeSegment(e);return c[PRIVATE_PROPERTIES.nodeMap].set(f.value,e),f})}var c=this;return this.datasource.nodes().then(function(d){return[].concat(a()).concat(b(d.all))})}},{key:'updateCounterList',value:function(){function b(f){e.hideCounters=!0,e.updateView(),e[PRIVATE_PROPERTIES.counters]=f,e.processingCounter=!1,e.hideCounters=!1}function c(f){e[PRIVATE_PROPERTIES.counterName]=f,e.counterReady=!0,e.counterDataComplete=!0,e.targetChanged()}var _this2=this,a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.target.nodeID,e=this;this.processingCounter=!0,this.counterReady=!1,this.counterDataComplete=!1,this.updateView(),function(f){// eslint-disable-line
return e.datasource.getCounters(f).then(function(g){var h=[];return Object.keys(g).forEach(function(j){if(0<j)for(var k=g[j].counters.map(function(m){return{text:m.displayName,value:m.name}}),l=Math.ceil(k.length/COUNTERS_SUBMENU_LENGTH),m=0;m<l;m+=1){var n=m*COUNTERS_SUBMENU_LENGTH,o=Math.min((m+1)*COUNTERS_SUBMENU_LENGTH,k.length),p=1<l?' ['+(n+1)+'..'+o+']':'',q=''+g[j].name+p;h.push({text:q,submenu:k.slice(n,o)})}}),{countersMenu:h,countersTable:g.table}})}(a).then(function(f){b(f.countersMenu),f.countersTable.some(function(g){return g.name===_this2.target.counterName})?c(_this2.target.counterName):(_this2.targetChanged(),_this2.counterFocus=!0)})}},{key:'nodeChanged',value:function(){function b(g){// eslint-disable-line
return f.datasource.isNodeTemplate(g)}function c(){f.nodeReady=!1,f.processingCounter=!0,f.counterReady=!1,f.counterDataComplete=!1}function d(g){return b(g)?(Object.assign(f[PRIVATE_PROPERTIES.nodeSegment],f.createVariableSegment(g.slice(1))),f.updateView(),Promise.resolve()):f.datasource.nodes().then(function(h){var j=h.all.find(function(k){return k.id===g});Object.assign(f[PRIVATE_PROPERTIES.nodeSegment],f.createNodeSegment(j)),f.updateView()})}var _this3=this,a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,f=this;(function(g){return null==g?b(f.nodeSegment.value)?Promise.resolve(f.nodeSegment.value):f[PRIVATE_PROPERTIES.nodeMap].has(f.nodeSegment.value)?Promise.resolve(f[PRIVATE_PROPERTIES.nodeMap].get(f.nodeSegment.value).id):Promise.resolve(null):b(g)?Promise.resolve(g):f.datasource.nodes().then(function(h){return h.all.some(function(j){return g===j.id})?g:null})})(a).then(function(g){if(_this3.target.nodeID=g,null==g)c(),Object.assign(_this3[PRIVATE_PROPERTIES.nodeSegment],_this3.createDefaultNodeSegment(DEFAULT_NODE_NAME)),_this3.targetChanged();else{var h=null==a?Promise.resolve():d(a);_this3.nodeReady=!0,_this3.processingCounter=!0,_this3.counterReady=!1,_this3.updateView(),h.then(function(){return f.updateCounterList(g)})}})}},{key:'counterChanged',value:function(a){this[PRIVATE_PROPERTIES.counterName]=a.value,this.target.counterName=a.value,this.counterDataComplete=!0,this.targetChanged()}},{key:'toggleShowOptions',value:function(){this.showOptions=!this.showOptions}},{key:'variableChanged',value:function(){this.updateCounterList()}},{key:'localVars',get:function(){return this.target.localVars},set:function(a){this.target.localVars=a}},{key:'processingNode',get:function(){return this.localVars.processingNode},set:function(a){this.localVars.processingNode=a}},{key:'nodeSpinner',get:function(){return this[PRIVATE_PROPERTIES.nodeSpinner]}},{key:'nodeSegment',get:function(){return this[PRIVATE_PROPERTIES.nodeSegment]}},{key:'nodeFocus',get:function(){return this[PRIVATE_PROPERTIES.nodeFocus]},set:function(a){this[PRIVATE_PROPERTIES.nodeFocus]=a}},{key:'nodeReady',get:function(){return this.localVars.nodeReady},set:function(a){this.localVars.nodeReady=a}},{key:'processingCounter',get:function(){return this.localVars.processingCounter},set:function(a){this.localVars.processingCounter=a}},{key:'defaultCounterName',get:function(){// eslint-disable-line
return DEFAULT_COUNTER_DISPLAY_NAME}},{key:'counterSpinner',get:function(){return this[PRIVATE_PROPERTIES.counterSpinner]}},{key:'counterFocus',get:function(){return this[PRIVATE_PROPERTIES.counterFocus]},set:function(a){this[PRIVATE_PROPERTIES.counterFocus]=a}},{key:'counterReady',get:function(){return this.localVars.counterReady},set:function(a){this.localVars.counterReady=a}},{key:'counterName',get:function(){return this[PRIVATE_PROPERTIES.counterName]}},{key:'counters',get:function(){return this[PRIVATE_PROPERTIES.counters]}},{key:'counterDataComplete',get:function(){return this.target.counterDataComplete},set:function(a){this.target.counterDataComplete=a}},{key:'alias',get:function(){return this.target.alias},set:function(a){this.target.alias=a}},{key:'series',get:function(){return this.target.series}},{key:'showOptions',get:function(){return this.localVars.showOptions},set:function(a){this.localVars.showOptions=a}}],[{key:'nodeDisplayValue',value:function(a){return null!=a.name&&''!==a.name?''+a.name+(null!=a.address&&''!==a.address?' ('+a.address+')':''):null!=a.address&&''!==a.address?a.address:''}},{key:'templateUrl',get:function(){return datasourceURL+'query/query.editor.html'},set:function(){// eslint-disable-line
}}]),NetCrunchQueryController}(QueryCtrl));NetCrunchQueryController.$inject=NET_CRUNCH_QUERY_CONTROLLER_DI;_export('NetCrunchQueryController',NetCrunchQueryController)}}});
//# sourceMappingURL=query.controller.js.map
