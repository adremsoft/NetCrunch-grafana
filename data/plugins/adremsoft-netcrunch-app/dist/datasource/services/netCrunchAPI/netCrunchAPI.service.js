'use strict';System.register(['angular','../../common','./adrem/module','./connectionCache','./netCrunchConnection/connection'],function(_export){'use strict';var angular,servicesModule,NetCrunchConnectionCache,NetCrunchConnection,CONNECTION_CONSTS,NETCRUNCH_TREND_DATA_CONST,_createClass,CONNECTION_ERROR_MESSAGES,MAX_SAMPLE_COUNT,NET_CRUNCH_API_SERVICE_DI,NetCrunchAPIService;function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError('Cannot call a class as a function')}return{setters:[function(_angular){angular=_angular.default},function(_common){servicesModule=_common.servicesModule},function(){},function(_connectionCache){NetCrunchConnectionCache=_connectionCache.NetCrunchConnectionCache},function(_netCrunchConnectionConnection){NetCrunchConnection=_netCrunchConnectionConnection.NetCrunchConnection;CONNECTION_CONSTS=_netCrunchConnectionConnection.CONNECTION_CONSTS;NETCRUNCH_TREND_DATA_CONST=_netCrunchConnectionConnection.NETCRUNCH_TREND_DATA_CONST}],execute:function(){_createClass=function(){function defineProperties(target,props){for(var descriptor,i=0;i<props.length;i++)descriptor=props[i],descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,'value'in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();_export('CONNECTION_ERROR_MESSAGES',CONNECTION_ERROR_MESSAGES=CONNECTION_CONSTS.ERROR_MESSAGES);_export('MAX_SAMPLE_COUNT',MAX_SAMPLE_COUNT=NETCRUNCH_TREND_DATA_CONST.MAX_SAMPLE_COUNT);NET_CRUNCH_API_SERVICE_DI=['adrem','alertSrv','backendSrv','$rootScope'];NetCrunchAPIService=function(){function NetCrunchAPIService(a,b,c,d){_classCallCheck(this,NetCrunchAPIService),this.adrem=a,this.alertSrv=b,this.backendSrv=c,this.$rootScope=d,this.cache=new NetCrunchConnectionCache}return _createClass(NetCrunchAPIService,[{key:'testConnection',value:function(a){var _this=this;return this.clearConnection(a).then(function(){return _this.getConnection(a,!0)}).then(function(){return _this.clearConnection(a)})}},{key:'clearConnection',value:function(a){var b=this;return new Promise(function(c){b.cache.connectionExist(a)?b.cache.getConnection(a).then(function(d){d.logout().then(function(){b.cache.deleteConnection(a),c()})}):c()})}},{key:'getConnection',value:function(a){function d(h){return new Promise(function(i,j){g.backendSrv.get(h.apiURL+'api.json').then(function(k){i(k)}).catch(function(k){k.isHandled=!0,j(CONNECTION_CONSTS.ERROR_SERVER_API)})})}function e(h,i){return i.onError=function(j){g.alertSrv.set(j.connectionName,j.message,'error')},i.onNodesChanged=function(){g.$rootScope.$broadcast('netcrunch-nodes-data-changed('+h.name+')')},i.onNetworksChanged=function(){g.$rootScope.$broadcast('netcrunch-networks-data-changed('+h.name+')')},i}function f(h,i){return new Promise(function(j,k){i.login(h.username,h.password,b).then(function(){i.fromCache=!1,j(i)}).catch(function(l){g.cache.deleteConnection(h),i.logout(),k(l)})})}var b=1<arguments.length&&void 0!==arguments[1]&&arguments[1],g=this;if(!this.cache.connectionExist(a)){var h=new NetCrunchConnection(this.adrem,a.url,a.name);return d(h).then(function(i){return new Promise(function(j,k){var l=NetCrunchConnection.checkApiVersion(i);0===l.status?j(l.version):k(l.status)})}).then(function(){return h=e(a,h),g.cache.addConnection(a,f(a,h)),g.cache.getConnection(a)})}return function(h){return g.cache.getConnection(h).then(function(i){return i.fromCache=!0,i})}(a)}}]),NetCrunchAPIService}();NetCrunchAPIService.$inject=NET_CRUNCH_API_SERVICE_DI;_export('CONNECTION_ERROR_MESSAGES',CONNECTION_ERROR_MESSAGES);_export('MAX_SAMPLE_COUNT',MAX_SAMPLE_COUNT);angular.module(servicesModule).service('netCrunchAPIService',NetCrunchAPIService)}}});
//# sourceMappingURL=netCrunchAPI.service.js.map
